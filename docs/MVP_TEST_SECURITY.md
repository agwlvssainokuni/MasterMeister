# 4.4.6 セキュリティ検証

## テスト環境準備

### 前提条件
- [ ] アプリケーション起動: `./gradlew bootRun -Pfrontend`
- [ ] 開発用データベース起動: `cd devenv && docker-compose up -d`
- [ ] H2コンソールアクセス確認: http://localhost:8080/h2-console
- [ ] テストユーザーと管理者ユーザー準備済み

---

## A. 認証機能検証

### 不正ログイン試行
- [ ] **存在しないメールアドレス**
  - [ ] `nonexistent@example.com` でログイン試行
  - [ ] 適切なエラーメッセージ表示確認
  - [ ] アカウント存在有無が推測できないメッセージであること
- [ ] **間違ったパスワード**
  - [ ] 正しいメール + 間違ったパスワードでログイン試行
  - [ ] 適切なエラーメッセージ表示確認
- [ ] **承認されていないユーザー**
  - [ ] 登録済み・未承認ユーザーでログイン試行
  - [ ] アクセス拒否メッセージ確認

### トークン管理
- [ ] **アクセストークン期限切れ**
  - [ ] 5分経過後のAPI呼び出し → 自動リフレッシュ確認
  - [ ] リフレッシュ処理のログ確認
- [ ] **リフレッシュトークン期限切れ**
  - [ ] 24時間経過シミュレーション（時刻変更またはトークン手動期限切れ）
  - [ ] ログイン画面への適切なリダイレクト確認
- [ ] **ログアウト後トークン無効化**
  - [ ] ログアウト実行
  - [ ] 旧トークンでのAPI呼び出し → 401エラー確認

---

## B. 認可・アクセス制御検証

### URL直接アクセス制御
- [ ] **未ログイン状態**
  - [ ] `/admin` 直接アクセス → ログイン画面リダイレクト
  - [ ] `/data-access` 直接アクセス → ログイン画面リダイレクト
- [ ] **一般ユーザー**
  - [ ] `/admin` 直接アクセス → 403エラーまたはダッシュボードリダイレクト
  - [ ] 管理者専用API直接呼び出し → 403エラー確認
- [ ] **権限のないリソース**
  - [ ] 権限のないテーブルの直接API呼び出し → 403エラー確認

### 権限ベースUI制御
- [ ] **テーブル表示制御**
  - [ ] 権限のないテーブルがデータベースツリーに表示されないこと
  - [ ] READ権限のあるテーブルのみ選択可能であること
- [ ] **カラム表示制御**
  - [ ] 権限のないカラムがテーブルから除外されること
  - [ ] フィルタ対象カラムに権限のないカラムが含まれないこと
- [ ] **UI要素制御**
  - [ ] 管理者メニューが一般ユーザーに表示されないこと
  - [ ] WRITE権限のないテーブルで編集ボタンが非表示であること

---

## C. 監査ログ動作確認

### H2コンソールでのログ確認
**アクセス**: http://localhost:8080/h2-console  
**JDBC URL**: `jdbc:h2:file:./data/mastermeister-dev`  
**ユーザー名**: `sa` (パスワードなし)

- [ ] **ログイン・ログアウト記録**
  ```sql
  SELECT * FROM audit_logs 
  WHERE action IN ('LOGIN_SUCCESS', 'LOGIN_FAILURE', 'LOGOUT') 
  ORDER BY created_at DESC LIMIT 10;
  ```
- [ ] **管理者操作記録**
  ```sql
  SELECT * FROM audit_logs 
  WHERE action IN ('USER_APPROVE', 'USER_REJECT') 
  ORDER BY created_at DESC LIMIT 10;
  ```
- [ ] **データベース操作記録**
  ```sql
  SELECT * FROM audit_logs 
  WHERE action IN ('DB_CONNECTION_TEST', 'SCHEMA_UPDATE') 
  ORDER BY created_at DESC LIMIT 10;
  ```
- [ ] **大量データクエリ記録**
  ```sql
  SELECT * FROM audit_logs 
  WHERE action = 'LARGE_DATASET_QUERY' 
  ORDER BY created_at DESC LIMIT 10;
  ```

### ログ内容確認
- [ ] タイムスタンプが正確に記録されていること
- [ ] ユーザー名が適切に記録されていること
- [ ] IPアドレスが記録されていること
- [ ] 操作詳細（details）が適切なJSON形式であること

---

## D. 入力値検証・SQLインジェクション対策

### フィルタ入力検証
- [ ] **SQLインジェクション試行**
  - [ ] フィルタに `'; DROP TABLE users;--` 入力
  - [ ] フィルタに `' OR 1=1--` 入力
  - [ ] 適切にエスケープされ、データベースに影響がないこと確認
- [ ] **特殊文字処理**
  - [ ] 日本語文字、絵文字での検索
  - [ ] HTML/XMLタグ入力での適切な処理
- [ ] **異常値入力**
  - [ ] 極端に長い文字列（1000文字以上）
  - [ ] バリデーションエラーまたは適切な切り詰め処理

### API入力検証
- [ ] **不正リクエスト**
  - [ ] Swagger UI または Postman で不正なJSON送信
  - [ ] 必須パラメータ欠損でのAPI呼び出し
  - [ ] 型不一致パラメータでのAPI呼び出し
  - [ ] 400 Bad Request の適切な返却確認

---

## E. セッション・CSRF対策

### セッション管理
- [ ] **複数セッション確認**
  - [ ] Chrome と Firefox で同じユーザーでログイン
  - [ ] 両方のブラウザで正常動作することを確認
- [ ] **セッション継続性**
  - [ ] ブラウザを閉じて再度開く
  - [ ] ログイン状態が適切に維持または要求されること

### CSRF対策確認
- [ ] **認証ヘッダー要求**
  - [ ] API呼び出し時にAuthorizationヘッダーが必要であること
  - [ ] 不正なトークンでのAPI呼び出し拒否
- [ ] **外部攻撃防止**
  - [ ] 外部サイトからのAjax呼び出しがCORSポリシーで拒否されること

---

## 期待される結果

### 成功基準
- [ ] 不正アクセスがすべて適切に拒否される
- [ ] 監査ログがすべての重要操作で記録される
- [ ] SQLインジェクション攻撃が防止される
- [ ] セッション管理が適切に動作する

### 失敗時の対応
- セキュリティ問題の詳細記録
- 監査ログの出力内容確認
- 開発者への即座の報告（セキュリティ問題は最優先）

---

## 確認ツール

- **H2コンソール**: http://localhost:8080/h2-console
- **ブラウザDevTools**: Network・Console・Security タブ
- **Swagger UI**: http://localhost:8080/api/swagger-ui.html
- **アプリケーションログ**: `./gradlew bootRun` 出力